<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ver Registro</title>
    <link rel="stylesheet" href="style.css">
    <style>
        #mapLink {
            display: none;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Detalles del Registro</h1>
        <div id="registroDetalle" class="registration-form"></div>
        
        <h2>Ubicación en Vivo</h2>
        <p id="ubicacionMensaje">Cargando ubicación...</p>
        <a id="mapLink" target="_blank">Ver ubicación en el mapa</a>

        <button onclick="window.location.href='consultar.html'">Volver a los registros</button>
        <button onclick="editarRegistro()">Editar</button> <!-- Botón de editar -->
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            mostrarRegistroIndividual();
            obtenerUbicacionEnVivo();
        });

        // Mostrar detalles del registro
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

function mostrarRegistroIndividual() {
    const id = obtenerParametroURL("id");
    const registros = JSON.parse(localStorage.getItem('registros')) || [];
    const registro = registros.find(r => r.id == id);
    const registroDetalle = document.getElementById("registroDetalle");

    try {
        const docRef = doc(db, "registros", id);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            const r = docSnap.data();
            registroDetalle.innerHTML = `
                <p><strong>Nombre Completo:</strong> ${r.nombre}</p>
                <p><strong>Fecha de Nacimiento:</strong> ${r.fechaNacimiento}</p>
                <p><strong>Edad:</strong> ${r.edad}</p>
                <p><strong>Alergias:</strong> ${r.alergias}</p>
                <p><strong>Enfermedad:</strong> ${r.enfermedad}</p>
                <p><strong>Medicamentos:</strong> ${r.medicamentos}</p>
                <p><strong>Seguro Médico:</strong> ${r.seguroMedico}</p>
                <p><strong>Domicilio:</strong> ${r.domicilio}</p>
                <p><strong>Nacionalidad:</strong> ${r.nacionalidad}</p>
                <p><strong>Contacto 1:</strong> ${r.contacto1.nombre} (${r.contacto1.parentesco}, ${r.contacto1.telefono})</p>
                <p><strong>Contacto 2:</strong> ${r.contacto2.nombre} (${r.contacto2.parentesco}, ${r.contacto2.telefono})</p>
            `;
        } else {
            registroDetalle.innerHTML = `<p>Registro no encontrado.</p>`;
        }
    } catch (error) {
        registroDetalle.innerHTML = `<p>Error al cargar registro: ${error.message}</p>`;
    }
}

        // Obtener ubicación en vivo
        function obtenerUbicacionEnVivo() {
            const ubicacionMensaje = document.getElementById('ubicacionMensaje');
            const mapLink = document.getElementById('mapLink');

            if (!navigator.geolocation) {
                ubicacionMensaje.textContent = 'La geolocalización no es soportada por tu navegador.';
                return;
            }

            // Usar watchPosition para actualizaciones en vivo
            navigator.geolocation.watchPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    // Actualizar texto de la ubicación
                    ubicacionMensaje.textContent = `Latitud: ${lat.toFixed(6)}, Longitud: ${lon.toFixed(6)}`;

                    // Actualizar enlace al mapa
                    mapLink.href = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}&zoom=15`;
                    mapLink.textContent = "Ver ubicación en el mapa";
                    mapLink.style.display = "block";
                },
                (error) => {
                    ubicacionMensaje.textContent = 'No se pudo obtener la ubicación: ' + error.message;
                },
                { enableHighAccuracy: true } // Alta precisión de la busqueda de la ubicacion exacta 
            );
        }

        // Función para redirigir a la página de edición
        function editarRegistro() {
            const verIndex = localStorage.getItem('verIndex');
            if (verIndex !== null) {
                window.location.href = `registro.html?editIndex=${verIndex}`;
            }
        }
    </script>
    <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries
  
  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyBedGvnwGUN2yddCFSMY5OF9-dB_aTIryU",
    authDomain: "life-aafbf.firebaseapp.com",
    projectId: "life-aafbf",
    storageBucket: "life-aafbf.firebasestorage.app",
    messagingSenderId: "660302314936",
    appId: "1:660302314936:web:e1f46d7d90405ca6d1634d",
    measurementId: "G-WENHBZHBBC"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>
</body>
</html>
